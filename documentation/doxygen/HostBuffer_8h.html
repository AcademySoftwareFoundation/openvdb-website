<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>OpenVDB: nanovdb/util/HostBuffer.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OpenVDB
   &#160;<span id="projectnumber">9.0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_9862d8700dece0becc08811a9cb1ac22.html">nanovdb</a></li><li class="navelem"><a class="el" href="dir_f9ca77ac9acdbd6a209f5e94183bcf27.html">util</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#namespaces">Namespaces</a> &#124;
<a href="#define-members">Macros</a>  </div>
  <div class="headertitle">
<div class="title">HostBuffer.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>HostBuffer - a buffer that contains a shared or private bump pool to either externally or internally managed host memory.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;cstdio&gt;</code><br />
<code>#include &lt;cstdlib&gt;</code><br />
<code>#include &lt;memory&gt;</code><br />
<code>#include &lt;mutex&gt;</code><br />
<code>#include &lt;unordered_set&gt;</code><br />
<code>#include &lt;cassert&gt;</code><br />
<code>#include &lt;sstream&gt;</code><br />
<code>#include &lt;cstring&gt;</code><br />
</div>
<p><a href="HostBuffer_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structnanovdb_1_1BufferTraits.html">BufferTraits&lt; BufferT &gt;</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classnanovdb_1_1HostBuffer.html">HostBuffer</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">This is a buffer that contains a shared or private pool to either externally or internally managed host memory.  <a href="classnanovdb_1_1HostBuffer.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structnanovdb_1_1HostBuffer_1_1Pool.html">HostBuffer::Pool</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="namespaces"></a>
Namespaces</h2></td></tr>
<tr class="memitem:namespacenanovdb"><td class="memItemLeft" align="right" valign="top"> &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacenanovdb.html">nanovdb</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:aff2830fced928188855df8b9366e031f"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="HostBuffer_8h.html#aff2830fced928188855df8b9366e031f">checkPtr</a>(ptr,  msg)</td></tr>
<tr class="separator:aff2830fced928188855df8b9366e031f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>HostBuffer - a buffer that contains a shared or private bump pool to either externally or internally managed host memory. </p>
<dl class="section date"><dt>Date</dt><dd>April 20, 2021</dd></dl>
<p>This HostBuffer can be used in multiple ways, most of which are demonstrated in the examples below. Memory in the pool can be managed or unmanged (e.g. internal or external) and can be shared between multiple buffers or belong to a single buffer.</p>
<p>Example that uses HostBuffer::create inside io::readGrids to create a full self-managed buffer, i.e. not shared and without padding, per grid in the file. </p><div class="fragment"><div class="line"><span class="keyword">auto</span> handles = <a class="code" href="namespacenanovdb_1_1io.html#a289b7a199b335c9b9d3fd10b4b076bb5">nanovdb::io::readGrids</a>(<span class="stringliteral">&quot;file.nvdb&quot;</span>);</div></div><!-- fragment --><p>Example that uses HostBuffer::createFull. Assuming you have a raw pointer to a NanoVDB grid of unknown type, this examples shows how to create its GridHandle which can be used to enquire about the grid type and meta data. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span>    *data;<span class="comment">// pointer to a NanoVDB grid of unknown type</span></div><div class="line">uint64_t size;<span class="comment">// byte size of NanoVDB grid of unknown type</span></div><div class="line"><span class="keyword">auto</span> buffer = <a class="code" href="classnanovdb_1_1HostBuffer.html#a659568e91cdae3848f81aace40620554">nanovdb::HostBuffer::createFull</a>(size, data);</div><div class="line"><a class="code" href="classnanovdb_1_1GridHandle.html">nanovdb::GridHandle&lt;&gt;</a> gridHandle(std::move(buffer));</div></div><!-- fragment --><p>Example that uses HostBuffer::createPool for internally managed host memory. Suppose you want to read multiple grids in multiple files, but reuse the same fixed sized memory buffer to both avoid memory fragmentation as well as exceeding the fixed memory ceiling! </p><div class="fragment"><div class="line"><span class="keyword">auto</span> pool = <a class="code" href="classnanovdb_1_1HostBuffer.html#aef4c6ec0920591bf597e2d3a37f2ef1e">nanovdb::HostBuffer::createPool</a>(1 &lt;&lt; 30);<span class="comment">// 1 GB memory pool</span></div><div class="line">std::vector&lt;std::string&gt;&gt; frames;<span class="comment">// vector of grid names</span></div><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;frames.size(); ++i) {</div><div class="line">    <span class="keyword">auto</span> handles = <a class="code" href="namespacenanovdb_1_1io.html#a289b7a199b335c9b9d3fd10b4b076bb5">nanovdb::io::readGrids</a>(frames[i], 0, pool);<span class="comment">// throws if grids in file exceed 1 GB</span></div><div class="line">    ...</div><div class="line">    pool.reset();<span class="comment">// clears all handles and resets the memory pool for reuse</span></div><div class="line">}</div></div><!-- fragment --><p>Example that uses HostBuffer::createPool for externally managed host memory. Note that in this example <code>handles</code> are allowed to outlive <code>pool</code> since they internally store a shared pointer to the memory pool. However <code>data</code> MUST outlive <code>handles</code> since the pool does not own its memory in this example. </p><div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> poolSize = 1 &lt;&lt; 30;<span class="comment">// 1 GB</span></div><div class="line">uint8_t *data = <span class="keyword">static_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(std::malloc(size));<span class="comment">// 1 GB buffer</span></div><div class="line"><span class="keyword">auto</span> pool = <a class="code" href="classnanovdb_1_1HostBuffer.html#aef4c6ec0920591bf597e2d3a37f2ef1e">nanovdb::HostBuffer::createPool</a>(poolSize, data);</div><div class="line"><span class="keyword">auto</span> handles1 = <a class="code" href="namespacenanovdb_1_1io.html#a289b7a199b335c9b9d3fd10b4b076bb5">nanovdb::io::readGrids</a>(<span class="stringliteral">&quot;file1.nvdb&quot;</span>, 0, pool);</div><div class="line"><span class="keyword">auto</span> handles2 = <a class="code" href="namespacenanovdb_1_1io.html#a289b7a199b335c9b9d3fd10b4b076bb5">nanovdb::io::readGrids</a>(<span class="stringliteral">&quot;file2.nvdb&quot;</span>, 0, pool);</div><div class="line">....</div><div class="line">std::free(data);</div></div><!-- fragment --><p>Example that uses HostBuffer::createPool for externally managed host memory. Note that in this example <code>handles</code> are allowed to outlive <code>pool</code> since they internally store a shared pointer to the memory pool. However <code>array</code> MUST outlive <code>handles</code> since the pool does not own its memory in this example. </p><div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> poolSize = 1 &lt;&lt; 30;<span class="comment">// 1 GB</span></div><div class="line">std::unique_ptr&lt;uint8_t[]&gt; array(<span class="keyword">new</span> uint8_t[size]);<span class="comment">// scoped buffer of 1 GB</span></div><div class="line"><span class="keyword">auto</span> pool = <a class="code" href="classnanovdb_1_1HostBuffer.html#aef4c6ec0920591bf597e2d3a37f2ef1e">nanovdb::HostBuffer::createPool</a>(poolSize, array.get());</div><div class="line"><span class="keyword">auto</span> handles = <a class="code" href="namespacenanovdb_1_1io.html#a289b7a199b335c9b9d3fd10b4b076bb5">nanovdb::io::readGrids</a>(<span class="stringliteral">&quot;file.nvdb&quot;</span>, 0, pool);</div></div><!-- fragment --> </div><h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="aff2830fced928188855df8b9366e031f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define checkPtr</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">ptr, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">msg&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">{ \</div><div class="line">        ptrAssert((ptr), (msg), __FILE__, __LINE__); \</div><div class="line">    }</div></div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
